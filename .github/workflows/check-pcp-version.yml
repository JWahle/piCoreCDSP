name: Check piCorePlayer Version

on:
  schedule:
    - cron: '0 0 * * *' # Run daily at midnight
  workflow_dispatch: # Allow manual trigger
  push:
    branches:
      - main
    paths:
      - '.github/workflows/check-pcp-version.yml'

jobs:
  check-version:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch current version from website
        id: fetch-version
        run: |
          # Fetch the page and extract the version number using grep with Perl-compatible regular expressions (PCRE)
          # It looks for "Download piCorePlayer " followed by a version number like "11.0.0"
          CURRENT_VERSION=$(curl -s https://docs.picoreplayer.org/downloads/ | grep -oP 'Download piCorePlayer \K[0-9]+\.[0-9]+\.[0-9]+' | head -n 1)
          
          if [ -z "$CURRENT_VERSION" ]; then
            echo "Error: Could not find version string on the page."
            exit 1
          fi
          
          echo "Detected version: $CURRENT_VERSION"
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

      - name: Verify version
        run: |
          EXPECTED_VERSION="11.0.0"
          DETECTED_VERSION="${{ steps.fetch-version.outputs.version }}"
          
          echo "Expected version: $EXPECTED_VERSION"
          echo "Detected version: $DETECTED_VERSION"
          
          if [ "$DETECTED_VERSION" != "$EXPECTED_VERSION" ]; then
            echo "::error::Version mismatch! Expected $EXPECTED_VERSION, but found $DETECTED_VERSION. The piCorePlayer website might have been updated."
            exit 1
          fi
          
          echo "Version match: $DETECTED_VERSION"
